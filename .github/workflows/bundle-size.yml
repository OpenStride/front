name: Bundle Size

on:
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-bundle:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build current branch
        run: npm run build:prod
        env:
          VITE_APP_BASE_URL: https://openstride.org

      - name: Analyze bundle size
        id: current
        run: |
          BUNDLE_SIZE=$(du -sb dist/ | cut -f1)
          echo "size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT
          echo "Current bundle size: $BUNDLE_SIZE bytes"

      - name: Checkout base branch
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.base_ref }}

      - name: Install dependencies (base)
        run: npm ci

      - name: Build base branch
        run: npm run build:prod
        env:
          VITE_APP_BASE_URL: https://openstride.org

      - name: Analyze base bundle size
        id: base
        run: |
          BASE_SIZE=$(du -sb dist/ | cut -f1)
          echo "size=$BASE_SIZE" >> $GITHUB_OUTPUT
          echo "Base bundle size: $BASE_SIZE bytes"

      - name: Compare bundle sizes
        id: compare
        run: |
          CURRENT=${{ steps.current.outputs.size }}
          BASE=${{ steps.base.outputs.size }}
          DIFF=$((CURRENT - BASE))
          PERCENT=$(awk "BEGIN {printf \"%.2f\", ($DIFF / $BASE) * 100}")

          echo "diff=$DIFF" >> $GITHUB_OUTPUT
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT

          echo "Bundle size comparison:"
          echo "Base: $BASE bytes"
          echo "Current: $CURRENT bytes"
          echo "Difference: $DIFF bytes ($PERCENT%)"

          # Alert if increase is more than 5%
          if (( $(echo "$PERCENT > 5" | bc -l) )); then
            echo "::warning::Bundle size increased by $PERCENT% (threshold: 5%)"
            exit 1
          fi

      - name: Comment PR with bundle size
        uses: actions/github-script@v7.0.1
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const current = ${{ steps.current.outputs.size }};
            const base = ${{ steps.base.outputs.size }};
            const diff = ${{ steps.compare.outputs.diff }};
            const percent = parseFloat('${{ steps.compare.outputs.percent }}');

            const formatBytes = (bytes) => {
              const kb = bytes / 1024;
              const mb = kb / 1024;
              if (mb >= 1) return `${mb.toFixed(2)} MB`;
              return `${kb.toFixed(2)} KB`;
            };

            const status = Math.abs(percent) > 5 ? 'âš ï¸' : percent > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            const summary = Math.abs(percent) > 5
              ? `**Warning:** Bundle size increased significantly!`
              : percent > 0
              ? `Bundle size increased slightly`
              : `Bundle size decreased`;

            const comment = `## ${status} Bundle Size Analysis

            ${summary}

            | Metric | Size | Change |
            |--------|------|--------|
            | **Base** | ${formatBytes(base)} | - |
            | **Current** | ${formatBytes(current)} | ${diff > 0 ? '+' : ''}${formatBytes(Math.abs(diff))} (${percent > 0 ? '+' : ''}${percent}%) |

            ${Math.abs(percent) > 5 ? 'âš ï¸ **Threshold exceeded:** Bundle size change is greater than 5%' : 'âœ… Bundle size change is within acceptable limits'}

            ---
            *Bundle size threshold: Â±5%*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
